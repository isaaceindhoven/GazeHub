<!DOCTYPE html>
<html class="h-full w-full" lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>
    
</head>
<body class="flex h-full w-full" x-data="main()" x-init="init()">

    <div class="flex flex-col w-1/3 flex-shrink-0 bg-gray-100 p-4 border-r border-gray-300">

        <div class="flex flex-col items-start">

            <div class="flex items-center mb-3">
                <label class="w-28">Connected:</label>
                <div 
                    class="w-3 h-3 rounded-full" 
                    :class="{
                        'bg-red-500' : !connected,
                        'bg-green-500' : connected,
                    }">
                </div>
            </div>

            <div class="flex items-center mb-3">
                <label class="w-28">Topic:</label>
                <input id="topic" class="px-2 py-1 rounded" type="text" value="ProductCreated">
            </div>

            <div class="flex items-center mb-3">
                <label class="w-28">Field:</label>
                <input id="field" class="px-2 py-1 rounded" type="text" value="id">
            </div>

            <div class="flex items-center mb-3">
                <label class="w-28">Operator:</label>
                <input id="operator" class="px-2 py-1 rounded" type="text" value="==">
            </div>

            <div class="flex items-center mb-3">
                <label class="w-28">Value:</label>
                <input id="value" class="px-2 py-1 rounded" type="text" value="1">
            </div>

            <div @click="subscribe()" class="ml-28 bg-purple-500 px-2 py-1 hover:bg-purple-600 text-white rounded cursor-pointer">
                Subscribe
            </div>

        </div>

        <div class="bg-gray-300 w-full my-6" style="height: 1px;"></div>

        <div class="flex flex-col items-start">

            <div class="flex items-center mb-3">
                <label class="w-28">Topic:</label>
                <input id="emit-topic" class="px-2 py-1 rounded" type="text" value="ProductCreated">
            </div>

            <div class="flex items-start mb-3">
                <label class="w-28">Payload:</label>
                <pre 
                    id="emit-payload" 
                    class="bg-gray-800 px-2 py-1 rounded text-white text-sm"
                    x-text="
                        JSON.stringify({
                            'id' : 1,
                            'name' : 'Gucci Shirt XL',
                            'price' : 10,
                            'meta' : {
                                'stock' : 4
                            },
                        }, null, 2);
                    " 
                    contenteditable="true">
                </pre>
            </div>

            <div @click="emit()" class="ml-28 bg-purple-500 px-2 py-1 hover:bg-purple-600 text-white rounded cursor-pointer">
                Emit
            </div>

        </div>
    </div>

    <div class="flex flex-col w-full bg-gray-100 p-4 border-r border-gray-300">
        <template x-for="callback in callbacks" :key="callback">
            <div class="relative border rounded p-3 bg-blue-100 text-blue-600 mb-4">
                <div class="flex items-center">
                    <div class="font-semibold" x-text="callback.meta.topic"></div>
                    <div class="ml-4" x-text="`${callback.meta.field} ${callback.meta.operator} ${callback.meta.value}`"></div>
                </div>
                <div x-text="JSON.stringify(callback.messages)"></div>
                <div @click="unsubscribe(callback.callbackId)" class="cursor-pointer hover:bg-red-600 font-bold flex flex-col text-center text-xs justify-center w-5 h-5 bg-red-500 rounded-full text-white absolute top-0 right-0 m-2">
                    <span>X</span>
                </div>
            </div>
        </template>
    </div>
    
    <script>

        const uuid = () => Math.random().toString(36).substring(7);

        function main() {
            return {
                connected: false,
                SSE: null,
                token: null,
                callbacks: [],
                
                async init(){
                    let req = await fetch("/token.php");
                    this.token = (await req.json()).token;

                    this.SSE = new EventSource(`http://localhost:8000/sse?token=${this.token}`);

                    this.SSE.onopen = () => { 
                        this.connected = true;
                    }

                    this.SSE.onmessage = m => {
                        let data = JSON.parse(m.data);
                        let callback = this.callbacks.find(c => c.callbackId == data.callbackId);
                        callback.handler(data.payload);
                    }
                },

                async subscribe(){
                    let topic = document.querySelector("#topic").value;
                    let field = document.querySelector("#field").value;
                    let operator = document.querySelector("#operator").value;
                    let value = document.querySelector("#value").value;
                    let callbackId = uuid();

                    try{
                        let val = JSON.parse(value);
                        value = val;
                    }catch{

                    }

                    this.callbacks.push({
                        meta: { topic, field, operator, value },
                        callbackId,
                        messages: [],
                        handler: (payload) => {
                            console.log(payload)
                            this.callbacks.find(c => c.callbackId == callbackId).messages.push(payload)
                        }
                    });

                    await fetch('http://localhost:8000/subscription', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify([
                            { callbackId, topic, field, operator, value }
                        ])
                    });
                },
                async unsubscribe(callbackId){
                    console.log("Unsubscrive", callbackId);
                },
                async emit(){
                    let topic = document.querySelector("#emit-topic").value;
                    let payload = JSON.parse(document.querySelector("#emit-payload").innerHTML);

                    await fetch('/emit.php', {
                        method: 'POST',
                        body: JSON.stringify(
                            { topic, payload }
                        )
                    });
                }
            }
        }

    </script>
</body>
</html>